import admin from 'firebase-admin'
import { readFileSync } from 'fs'

// Ler chaves JSON
const oldServiceAccount = JSON.parse(readFileSync('./firebase-old-key.json', 'utf8'))
const newServiceAccount = JSON.parse(readFileSync('./firebase-new-key.json', 'utf8'))

// Inicializar Firebase Admin para ambos os projetos
const oldApp = admin.initializeApp({
  credential: admin.credential.cert(oldServiceAccount)
}, 'old')

const newApp = admin.initializeApp({
  credential: admin.credential.cert(newServiceAccount)
}, 'new')

const oldDb = oldApp.firestore()
const newDb = newApp.firestore()

async function migrateCollection(collectionName) {
  console.log(`\nüì¶ Migrando collection: ${collectionName}`)
  
  try {
    const snapshot = await oldDb.collection(collectionName).get()
    const total = snapshot.size
    
    console.log(`üìä Total de documentos encontrados: ${total}`)
    
    if (total === 0) {
      console.log(`‚ö†Ô∏è  Collection vazia`)
      return
    }

    let migrated = 0
    const batch = newDb.batch()
    
    for (const doc of snapshot.docs) {
      const docRef = newDb.collection(collectionName).doc(doc.id)
      batch.set(docRef, doc.data())
      migrated++
      
      // Commit a cada 500 documentos (limite do Firestore)
      if (migrated % 500 === 0) {
        await batch.commit()
        console.log(`‚úì Migrados: ${migrated}/${total}`)
      }
    }
    
    // Commit final
    await batch.commit()
    console.log(`‚úÖ ${collectionName}: ${migrated} documentos migrados com sucesso!`)
    
  } catch (error) {
    console.error(`‚ùå Erro ao migrar ${collectionName}:`, error.message)
    throw error
  }
}

async function migrate() {
  console.log("üöÄ Iniciando migra√ß√£o com Firebase Admin SDK...")
  console.log("=".repeat(60))
  
  try {
    // Migrar trades
    await migrateCollection("trades")
    
    // Migrar usu√°rios
    await migrateCollection("users")
    
    console.log("\n" + "=".repeat(60))
    console.log("üéâ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!")
    console.log("=".repeat(60))
    
    process.exit(0)
    
  } catch (error) {
    console.error("\n‚ùå ERRO NA MIGRA√á√ÉO:", error)
    process.exit(1)
  }
}

migrate()
